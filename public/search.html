<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>æ–‡ä»¶æœç´¢ä¸ç®¡ç†</title>
<style>
body{font-family:"Segoe UI",Tahoma,sans-serif;font-size:14px;color:#333;margin:0;padding:10px;}
.back-link{display:block;margin-bottom:15px;color:#4a6cf7;text-decoration:none;}
.search-input{padding:5px 8px;border:1px solid #ddd;width:300px;}
.search-btn{background:#4a6cf7;color:white;border:none;padding:6px 10px;cursor:pointer;margin:0 2px;}
.search-btn:hover{background:#3653d3;}
.delete-btn{background:none;border:none;color:#d9534f;cursor:pointer;font-size:16px;padding:0 4px;line-height:1;}
.delete-btn:hover{transform:scale(1.2);}
.batch-delete-btn{background:none;border:1px solid #d9534f;color:#d9534f;padding:5px 10px;cursor:pointer;font-size:14px;border-radius:4px;margin-top:8px;}
.batch-delete-btn:hover{background:#d9534f;color:white;}
.file-list{margin-top:10px;}
.file-item{padding:3px 0;display:flex;align-items:center;gap:6px;}
.file-link{text-decoration:none;color:#1a0dab;flex-shrink:0;}
.file-time{color:#d9534f;margin-left:5px;}
.file-size{color:#5cb85c;margin-left:5px;}
.remark-btn{background:none;border:none;color:#f0ad4e;cursor:pointer;font-size:14px;padding:0 4px;}
.remark-btn:hover{color:#ec971f;}
.password-btn{background:none;border:none;color:#5bc0de;cursor:pointer;font-size:14px;padding:0 4px;}
.password-btn:hover{color:#31b0d5;}
.remark-preview{color:#777;font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-left:5px;}
.message{margin-bottom:10px;color:#007bff;}
input[type=checkbox]{margin-right:5px;}
.select-controls{margin:6px 0;}
.upload-progress{width:100%;height:18px;background:#eee;margin-top:5px;border-radius:4px;overflow:hidden;}
.upload-bar{height:100%;width:0%;background:#4a6cf7;color:white;text-align:center;font-size:12px;line-height:18px;}
.password-input{margin-top:6px;padding:6px;width:100%;box-sizing:border-box;border:1px solid #ddd;}
</style>
</head>

<body>
<a href="./" class="back-link">ï¼ï¼ï¼ è¿”å›</a>
<div id="messages"></div>

<form method="post" id="searchForm">
<label>æœç´¢è¯:</label>
<input type="text" name="keyword" class="search-input" value="">
<label><input type="checkbox" name="include_pwd"> æ˜¾ç¤ºå¯†ç æ–‡ä»¶(.pwd)</label>
<input type="hidden" id="sortField" name="sort_field" value="ctime">
<input type="hidden" id="sortOrder" name="sort_order" value="desc">
<input type="submit" name="submit_search" class="search-btn" value="æœç´¢">
<input type="submit" name="show_all" class="search-btn" value="æ˜¾ç¤ºå…¨éƒ¨æ–‡ä»¶">
<button type="button" class="search-btn" onclick="toggleSort('ctime')">æ—¶é—´æ’åº (-)</button>
<button type="button" class="search-btn" onclick="toggleSort('size')">å¤§å°æ’åº (-)</button>
<button type="button" class="search-btn" onclick="editFile()">ğŸ†• æ–°å»ºæ–‡ä»¶</button>
<button type="button" class="search-btn" onclick="uploadFiles()">ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</button>
</form>

<div id="searchResults"></div>

<script>
// é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºæç¤º
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('messages').innerHTML = '<div class="message">è¯·ä½¿ç”¨æœç´¢åŠŸèƒ½æˆ–ç‚¹å‡»"æ˜¾ç¤ºå…¨éƒ¨æ–‡ä»¶"æ¥æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨</div>';
});

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°å‡½æ•°
function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + 'B';
  if (bytes < 1048576) return (bytes / 1024).toFixed(2) + 'KB';
  return (bytes / 1048576).toFixed(2) + 'MB';
}

// æ’åºåŠŸèƒ½
function toggleSort(field){
    const form = document.getElementById('searchForm');
    const fieldInput = document.getElementById('sortField');
    const orderInput = document.getElementById('sortOrder');
    
    if(fieldInput.value === field){
        orderInput.value = (orderInput.value === 'asc') ? 'desc' : 'asc';
    } else {
        fieldInput.value = field;
        orderInput.value = 'asc';
    }
    
    // ç§»é™¤æ—§çš„éšè—å­—æ®µ
    const oldForceSearch = document.getElementById('force_search');
    const oldForceShowAll = document.getElementById('force_show_all');
    if(oldForceSearch) oldForceSearch.remove();
    if(oldForceShowAll) oldForceShowAll.remove();
    
    // æ·»åŠ æ–°çš„éšè—å­—æ®µ
    const hidden = document.createElement('input');
    hidden.type = 'hidden';
    hidden.name = 'force_search';
    hidden.id = 'force_search';
    hidden.value = '1';
    form.appendChild(hidden);
    
    form.submit();
}

// æ–‡ä»¶é€‰æ‹©åŠŸèƒ½
function toggleSelectAll(check){
    const checkboxes = document.querySelectorAll('input[name="selected_files[]"]');
    checkboxes.forEach(function(checkbox) {
        checkbox.checked = check;
    });
}

function invertSelection(){
    const checkboxes = document.querySelectorAll('input[name="selected_files[]"]');
    checkboxes.forEach(function(checkbox) {
        checkbox.checked = !checkbox.checked;
    });
}

// å¼¹çª—ç¼–è¾‘/æ–°å»º
function editFile(filename){
    if(filename === undefined) filename = '';
    
    // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
    const existingModal = document.getElementById('editModal');
    const existingOverlay = document.getElementById('modalOverlay');
    if(existingModal) existingModal.remove();
    if(existingOverlay) existingOverlay.remove();

    // åˆ›å»ºé®ç½©å±‚
    const overlay = document.createElement('div');
    overlay.id = 'modalOverlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);z-index:999;';
    overlay.onclick = function(){overlay.remove(); modal.remove();};
    document.body.appendChild(overlay);

    // åˆ›å»ºæ¨¡æ€æ¡†
    const modal = document.createElement('form');
    modal.id = 'editModal';
    modal.method = 'post';
    modal.style.cssText = 'display:flex;flex-direction:column;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:700px;max-width:95%;height:550px;min-height:350px;padding:10px;background:white;border:1px solid #ccc;box-shadow:0 0 12px rgba(0,0,0,0.3);z-index:1000;';
    
    modal.innerHTML = '<div id="modalHeader" style="cursor:move;padding:8px 10px;background:#f1f1f1;border-bottom:1px solid #ccc;display:flex;justify-content:space-between;align-items:center;"><span>ç¼–è¾‘æ–‡ä»¶</span><div class="btn-group"><button type="button" id="maximizeBtn">ğŸ–¥ï¸ æœ€å¤§åŒ–/æ¢å¤</button><span class="close-btn" style="cursor:pointer;color:#d9534f;font-weight:bold;font-size:16px;">Ã—</span></div></div><input type="text" name="file_name" id="edit_file_name" style="width:100%;margin-top:6px;padding:6px;box-sizing:border-box;font-family:monospace;font-size:14px;"><input type="text" name="file_password" id="edit_file_password" placeholder="æ–‡ä»¶å¯†ç ï¼ˆæ–°å»ºæ–‡ä»¶å¿…å¡«ï¼‰" style="width:100%;margin-top:6px;padding:6px;box-sizing:border-box;font-family:monospace;font-size:14px;"><textarea name="file_content" id="edit_file_content" style="flex:1;width:100%;margin-top:6px;padding:6px;box-sizing:border-box;font-family:monospace;font-size:14px;resize:none;"></textarea><button type="submit" name="save_file" class="search-btn" style="margin-top:6px;">ğŸ’¾ ä¿å­˜æ–‡ä»¶</button><div id="resizeHandle" style="width:15px;height:15px;background:#ccc;position:absolute;right:2px;bottom:2px;cursor:se-resize;"></div>';
    
    document.body.appendChild(modal);

    const fname = modal.querySelector('#edit_file_name');
    const fpassword = modal.querySelector('#edit_file_password');
    const fcontent = modal.querySelector('#edit_file_content');
    fname.value = filename;
    
    if(filename){
        fname.readOnly = true;
        fpassword.placeholder = "æ–‡ä»¶å¯†ç ï¼ˆç¼–è¾‘æ—¶æ— éœ€ä¿®æ”¹ï¼‰";
        fpassword.required = false;
        
        // åŠ è½½æ–‡ä»¶å†…å®¹
        fetch('/z/' + encodeURIComponent(filename))
            .then(function(r){ return r.text(); })
            .then(function(t){ 
                fcontent.value = t; 
            })
            .catch(function(){ 
                fcontent.value = '(æ— æ³•æ˜¾ç¤ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ç›´æ¥ä¿å­˜è¦†ç›–)'; 
            });
    } else { 
        fname.readOnly = false; 
        fpassword.required = true;
        fcontent.value = ''; 
    }

    // å…³é—­æŒ‰é’®äº‹ä»¶
    modal.querySelector('.close-btn').onclick = function(){modal.remove(); overlay.remove();};

    // æ‹–æ‹½åŠŸèƒ½
    const header = modal.querySelector('#modalHeader');
    let isDragging = false, offsetX = 0, offsetY = 0;
    header.addEventListener('mousedown', function(e){
        if(e.target.tagName !== 'BUTTON'){
            isDragging = true;
            offsetX = e.clientX - modal.offsetLeft;
            offsetY = e.clientY - modal.offsetTop;
        }
    });
    
    document.addEventListener('mousemove', function(e){
        if(isDragging){
            modal.style.left = (e.clientX - offsetX) + 'px';
            modal.style.top = (e.clientY - offsetY) + 'px';
        }
    });
    
    document.addEventListener('mouseup', function(e){
        isDragging = false;
    });

    // æœ€å¤§åŒ–/æ¢å¤åŠŸèƒ½
    let isMaximized = false, prevSize = {width:0, height:0, left:0, top:0};
    const maximizeBtn = modal.querySelector('#maximizeBtn');
    maximizeBtn.onclick = function(){
        if(!isMaximized){
            prevSize.width = modal.offsetWidth;
            prevSize.height = modal.offsetHeight;
            prevSize.left = modal.offsetLeft;
            prevSize.top = modal.offsetTop;
            modal.style.left = '0';
            modal.style.top = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.transform = 'none';
            isMaximized = true;
        } else {
            modal.style.width = prevSize.width + 'px';
            modal.style.height = prevSize.height + 'px';
            modal.style.left = prevSize.left + 'px';
            modal.style.top = prevSize.top + 'px';
            modal.style.transform = 'translate(-50%,-50%)';
            isMaximized = false;
        }
        adjustTextarea();
    };

    // è°ƒæ•´å¤§å°åŠŸèƒ½
    const resizeHandle = modal.querySelector('#resizeHandle');
    let isResizing = false;
    resizeHandle.addEventListener('mousedown', function(e){
        e.stopPropagation();
        isResizing = true;
    });
    
    document.addEventListener('mousemove', function(e){
        if(isResizing){
            modal.style.width = (e.clientX - modal.offsetLeft) + 'px';
            modal.style.height = (e.clientY - modal.offsetTop) + 'px';
            adjustTextarea();
        }
    });
    
    document.addEventListener('mouseup', function(e){
        isResizing = false;
    });

    function adjustTextarea(){
        const headerHeight = header.offsetHeight;
        const nameHeight = fname.offsetHeight;
        const passwordHeight = fpassword.offsetHeight;
        const btnHeight = modal.querySelector('button[name="save_file"]').offsetHeight;
        const padding = 40;
        fcontent.style.height = (modal.offsetHeight - headerHeight - nameHeight - passwordHeight - btnHeight - padding) + 'px';
    }
    
    window.addEventListener('resize', adjustTextarea);
    adjustTextarea();
}

// æ˜¾ç¤ºå¯†ç åŠŸèƒ½
function showPassword(filename, password){
    // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
    const existingModal = document.getElementById('passwordModal');
    const existingOverlay = document.getElementById('passwordOverlay');
    if(existingModal) existingModal.remove();
    if(existingOverlay) existingOverlay.remove();

    // åˆ›å»ºé®ç½©å±‚
    const overlay = document.createElement('div');
    overlay.id = 'passwordOverlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);z-index:999;';
    document.body.appendChild(overlay);

    // åˆ›å»ºæ¨¡æ€æ¡†
    const modal = document.createElement('div');
    modal.id = 'passwordModal';
    modal.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:400px;max-width:90%;padding:15px;background:white;border:1px solid #ccc;box-shadow:0 0 12px rgba(0,0,0,0.3);z-index:1000;';
    
    modal.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><span><strong>æ–‡ä»¶å¯†ç ï¼š</strong>' + filename + '</span><span class="close-btn" style="cursor:pointer;color:#d9534f;font-weight:bold;font-size:16px;">Ã—</span></div><div style="padding:10px;background:#f9f9f9;border:1px solid #ddd;border-radius:4px;margin-bottom:10px;"><strong>å¯†ç ï¼š</strong><span style="font-family:monospace;color:#d9534f;">' + password + '</span></div><div style="display:flex;justify-content:space-between;"><button type="button" class="search-btn" onclick="copyPassword(\\'' + password + '\\')">ğŸ“‹ å¤åˆ¶å¯†ç </button><button type="button" class="search-btn" onclick="editPassword(\\'' + filename + '\\', \\'' + password + '\\')">âœï¸ ä¿®æ”¹å¯†ç </button></div>';
    
    document.body.appendChild(modal);

    // å…³é—­æŒ‰é’®äº‹ä»¶
    modal.querySelector('.close-btn').onclick = function(){modal.remove(); overlay.remove();};
    overlay.onclick = function(){modal.remove(); overlay.remove();};
}

// å¤åˆ¶å¯†ç å‡½æ•°
function copyPassword(password) {
    navigator.clipboard.writeText(password)
        .then(() => alert('å¯†ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))
        .catch(err => alert('å¤åˆ¶å¤±è´¥: ' + err));
}

// ä¿®æ”¹å¯†ç åŠŸèƒ½
function editPassword(filename, currentPassword){
    // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
    const existingModal = document.getElementById('editPasswordModal');
    const existingOverlay = document.getElementById('editPasswordOverlay');
    if(existingModal) existingModal.remove();
    if(existingOverlay) existingOverlay.remove();

    // åˆ›å»ºé®ç½©å±‚
    const overlay = document.createElement('div');
    overlay.id = 'editPasswordOverlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);z-index:999;';
    document.body.appendChild(overlay);

    // åˆ›å»ºæ¨¡æ€æ¡†
    const modal = document.createElement('form');
    modal.id = 'editPasswordModal';
    modal.method = 'post';
    modal.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:400px;max-width:90%;padding:15px;background:white;border:1px solid #ccc;box-shadow:0 0 12px rgba(0,0,0,0.3);z-index:1000;';
    
    modal.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><span><strong>ä¿®æ”¹å¯†ç ï¼š</strong>' + filename + '</span><span class="close-btn" style="cursor:pointer;color:#d9534f;font-weight:bold;font-size:16px;">Ã—</span></div><div style="margin-bottom:10px;"><label>å½“å‰å¯†ç ï¼š</label><span style="font-family:monospace;color:#777;">' + currentPassword + '</span></div><input type="text" name="new_password" placeholder="è¾“å…¥æ–°å¯†ç " value="' + currentPassword + '" style="width:100%;padding:8px;box-sizing:border-box;border:1px solid #ddd;margin-bottom:10px;"><div style="display:flex;justify-content:space-between;"><button type="button" class="search-btn" onclick="updatePassword(\\'' + filename + '\\', this.form.new_password.value)">ğŸ’¾ æ›´æ–°å¯†ç </button></div>';
    
    document.body.appendChild(modal);

    // å…³é—­æŒ‰é’®äº‹ä»¶
    modal.querySelector('.close-btn').onclick = function(){modal.remove(); overlay.remove();};
    overlay.onclick = function(){modal.remove(); overlay.remove();};
}

// æ›´æ–°å¯†ç å‡½æ•°
function updatePassword(filename, newPassword) {
    if (!newPassword) {
        alert('è¯·è¾“å…¥æ–°å¯†ç ');
        return;
    }
    
    const xhr = new XMLHttpRequest();
    xhr.open('POST', 'update_password.php', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    
    const params = 'filename=' + encodeURIComponent(filename) + 
                  '&new_password=' + encodeURIComponent(newPassword);
    
    xhr.send(params);
    
    xhr.onload = function() {
        if(xhr.status === 200) {
            try {
                const response = JSON.parse(xhr.responseText);
                if(response.success) {
                    alert('å¯†ç æ›´æ–°æˆåŠŸ');
                    document.getElementById('editPasswordModal').remove();
                    document.getElementById('editPasswordOverlay').remove();
                    document.getElementById('passwordModal').remove();
                    document.getElementById('passwordOverlay').remove();
                    location.reload();
                } else {
                    alert('å¯†ç æ›´æ–°å¤±è´¥: ' + (response.error || ''));
                }
            } catch(e) {
                alert('è§£æå“åº”å¤±è´¥: ' + e.message);
            }
        } else {
            alert('è¯·æ±‚å¤±è´¥: ' + xhr.statusText);
        }
    };
    
    xhr.onerror = function() {
        alert('ç½‘ç»œé”™è¯¯');
    };
}

// ç¼–è¾‘å¤‡æ³¨å¼¹çª— - ä¿®å¤ç‰ˆæœ¬
function editRemark(filename, currentRemark){
    if(currentRemark === undefined) currentRemark = '';
    
    // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
    const existingModal = document.getElementById('remarkModal');
    const existingOverlay = document.getElementById('remarkOverlay');
    if(existingModal) existingModal.remove();
    if(existingOverlay) existingOverlay.remove();

    // åˆ›å»ºé®ç½©å±‚
    const overlay = document.createElement('div');
    overlay.id = 'remarkOverlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);z-index:999;';
    document.body.appendChild(overlay);

    // åˆ›å»ºæ¨¡æ€æ¡† - ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„è¡¨å•å­—æ®µåå’Œæäº¤æ–¹å¼
    const modal = document.createElement('form');
    modal.id = 'remarkModal';
    modal.method = 'post';
    modal.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:500px;max-width:90%;padding:15px;background:white;border:1px solid #ccc;box-shadow:0 0 12px rgba(0,0,0,0.3);z-index:1000;';
    
    modal.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><span><strong>ç¼–è¾‘å¤‡æ³¨ï¼š</strong>' + filename + '</span><span class="close-btn" style="cursor:pointer;color:#d9534f;font-weight:bold;font-size:16px;">Ã—</span></div><input type="hidden" name="file_name" value="' + filename + '"><textarea name="remark_content" style="width:100%;height:120px;padding:8px;box-sizing:border-box;border:1px solid #ddd;resize:vertical;">' + currentRemark + '</textarea><div style="margin-top:10px;display:flex;justify-content:space-between;"><button type="button" class="search-btn" onclick="this.form.querySelector(\\'textarea\\').value=\\'\\'">æ¸…ç©ºå¤‡æ³¨</button><button type="submit" name="save_remark" value="1" class="search-btn">ğŸ’¾ ä¿å­˜å¤‡æ³¨</button></div>';
    
    document.body.appendChild(modal);

    // å…³é—­æŒ‰é’®äº‹ä»¶
    modal.querySelector('.close-btn').onclick = function(){modal.remove(); overlay.remove();};
    overlay.onclick = function(){modal.remove(); overlay.remove();};
}

// ä¸Šä¼ æ–‡ä»¶å¼¹çª—
function uploadFiles(){
    // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
    const existingModal = document.getElementById('uploadModal');
    const existingOverlay = document.getElementById('uploadOverlay');
    if(existingModal) existingModal.remove();
    if(existingOverlay) existingOverlay.remove();

    // åˆ›å»ºé®ç½©å±‚
    const overlay = document.createElement('div');
    overlay.id = 'uploadOverlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);z-index:999;';
    document.body.appendChild(overlay);

    // åˆ›å»ºæ¨¡æ€æ¡†
    const modal = document.createElement('div');
    modal.id = 'uploadModal';
    modal.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:500px;max-width:90%;max-height:80%;padding:10px;background:white;border:1px solid #ccc;box-shadow:0 0 12px rgba(0,0,0,0.3);z-index:1000;display:flex;flex-direction:column;';
    
    modal.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;"><span>ä¸Šä¼ æ–‡ä»¶</span><span class="close-btn" style="cursor:pointer;color:#d9534f;font-weight:bold;font-size:16px;">Ã—</span></div><div style="margin-bottom:10px;"><input type="text" id="uploadPassword" placeholder="æ–‡ä»¶å¯†ç ï¼ˆé»˜è®¤ï¼šdefault_passwordï¼‰" style="width:100%;padding:6px;box-sizing:border-box;"></div><div id="uploadContent" style="flex:1;overflow:auto;padding:5px;border:1px dashed #aaa;display:flex;flex-direction:column;gap:4px;"><input type="file" id="fileInput" multiple><div id="fileList"></div><div id="progressContainer"></div></div><button id="startUpload" class="search-btn" style="margin-top:6px;">ğŸ“¤ å¼€å§‹ä¸Šä¼ </button>';
    
    document.body.appendChild(modal);

    // å…³é—­æŒ‰é’®äº‹ä»¶
    modal.querySelector('.close-btn').onclick = function(){modal.remove(); overlay.remove();};

    const startBtn = modal.querySelector('#startUpload');
    const fileInput = modal.querySelector('#fileInput');
    const fileList = modal.querySelector('#fileList');
    const progressContainer = modal.querySelector('#progressContainer');
    const uploadPassword = modal.querySelector('#uploadPassword');

    // æ˜¾ç¤ºé€‰æ‹©çš„æ–‡ä»¶åˆ—è¡¨
    fileInput.addEventListener('change', function() {
        fileList.innerHTML = '';
        for(let i = 0; i < this.files.length; i++) {
            const file = this.files[i];
            const fileItem = document.createElement('div');
            fileItem.style.cssText = 'padding:4px;border-bottom:1px solid #eee;font-size:12px;';
            fileItem.textContent = file.name + ' (' + formatFileSize(file.size) + ')';
            fileList.appendChild(fileItem);
        }
    });

    startBtn.onclick = function(){
        const files = fileInput.files;
        if (files.length === 0) {
            alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
            return;
        }

        const password = uploadPassword.value || 'default_password';
        let completedCount = 0;

        for(let i = 0; i < files.length; i++){
            const file = files[i];
            const progressBar = document.createElement('div');
            progressBar.className = 'upload-progress';
            progressBar.innerHTML = '<div class="upload-bar">0% - ' + file.name + '</div>';
            progressContainer.appendChild(progressBar);

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const xhr = new XMLHttpRequest();
                xhr.open('POST', 'upload.php', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                
                xhr.onload = function(){
                    completedCount++;
                    if(xhr.status === 200){
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if(response.success) {
                                progressBar.firstChild.style.width = '100%';
                                progressBar.firstChild.style.background = '#5cb85c';
                                progressBar.firstChild.textContent = 'å®Œæˆ - ' + file.name;
                            } else {
                                progressBar.firstChild.style.background = '#d9534f';
                                progressBar.firstChild.textContent = 'å¤±è´¥ - ' + file.name + ': ' + response.error;
                            }
                        } catch(e) {
                            progressBar.firstChild.style.background = '#d9534f';
                            progressBar.firstChild.textContent = 'é”™è¯¯ - ' + file.name;
                        }
                    } else {
                        progressBar.firstChild.style.background = '#d9534f';
                        progressBar.firstChild.textContent = 'å¤±è´¥ - ' + file.name;
                    }
                    
                    // æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆååˆ·æ–°é¡µé¢
                    if (completedCount === files.length) {
                        setTimeout(() => {
                            modal.remove();
                            overlay.remove();
                            location.reload();
                        }, 1000);
                    }
                };
                
                xhr.onerror = function(){
                    completedCount++;
                    progressBar.firstChild.style.background = '#d9534f';
                    progressBar.firstChild.textContent = 'é”™è¯¯ - ' + file.name;
                    
                    if (completedCount === files.length) {
                        setTimeout(() => {
                            modal.remove();
                            overlay.remove();
                            location.reload();
                        }, 1000);
                    }
                };
                
                // æ„å»ºè¡¨å•æ•°æ®
                const params = 'filename=' + encodeURIComponent(file.name) + 
                              '&password=' + encodeURIComponent(password) + 
                              '&content=' + encodeURIComponent(content);
                xhr.send(params);
            };
            
            reader.onerror = function() {
                completedCount++;
                progressBar.firstChild.style.background = '#d9534f';
                progressBar.firstChild.textContent = 'è¯»å–å¤±è´¥ - ' + file.name;
                
                if (completedCount === files.length) {
                    setTimeout(() => {
                        modal.remove();
                        overlay.remove();
                        location.reload();
                    }, 1000);
                }
            };
            
            reader.readAsText(file);
        }
    };
}
</script>
</body>
</html>
